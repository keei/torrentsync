#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
self_file =
  if File.symlink?(__FILE__)
    require 'pathname'
    Pathname.new(__FILE__).realpath
  else
    __FILE__
  end
$:.unshift(File.dirname(self_file) + "/../lib")

require 'torrentsync'
require 'choice'

Choice.options do
  option :sync do
    short '-s'
  end
  option :dryrun do
    short '-n'
  end
  option :html do
    short '-h'
  end
end

c = Choice.choices
if c.sync
  peers = get_peers
  torrents, status = get_torrents(peers)
  dead_peers = status.select{|k,v| v == :dead}.map(&:first)
  sync_torrents(peers - dead_peers, torrents, 2, c.dryrun)
end
if c.html
  peers = get_peers
  torrents, status = get_torrents(peers)
  dead_peers = status.select{|k,v| v == :dead}.map(&:first)
  puts "<html>"
  puts "<body>"

  puts "<table>"
  puts "<tr><th>Client</th><th>Host</th><th>Port</th><th>Dead?</th></tr>"
  peers.each do |peer|
    dead = dead_peers.include? peer
    puts "<tr><td>#{peer[0]}</td><td>#{peer[1]}</td><td>#{peer[2]}</td><td>#{dead}</td></tr>"
  end
  puts "</table>"

  puts "<table>"
  puts "<tr><th>Hash</th><th>Name</th><th>Peers</th></tr>"
  torrents.each do |hash, t|
    total = t[:peers].inject(0.0){|v,h|v + h[1]}
    puts "<tr><td>#{hash}</td><td>#{t[:name]}</td><td>#{t[:peers].size}(#{(total * 100).to_i}%)</td></tr>"
  end
  puts "</table>"

  puts "</body>"
  puts "</html>"
end
