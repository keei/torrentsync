#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
self_file =
  if File.symlink?(__FILE__)
    require 'pathname'
    Pathname.new(__FILE__).realpath
  else
    __FILE__
  end
$:.unshift(File.dirname(self_file) + "/../lib")

require 'torrentsync'
require 'choice'

Choice.options do
  option :sync do
    short '-s'
  end
  option :dryrun do
    short '-n'
  end
  option :remove do
    short '-r'
  end
end

c = Choice.choices
if c.sync
  peers = get_peers
  torrents, status = get_torrents(peers)
  dead_peers = status.select{|k,v| v == :dead}.map(&:first)
  sync_torrents(peers - dead_peers, torrents, 2, c.dryrun)
elsif c.remove
  id = c.remove
  peers = get_peers
  torrents, status = get_torrents(peers)
  t = torrents[id]
  unless t
    puts 'not found'
    exit 1
  end
  hps = t[:peers].map{|hp| host, port = hp[0].split(':'); [host, port.to_i]}
  haves = peers.select do |peer|
    hps.any?{|hp| peer[1] == hp[0] && peer[2] == hp[1]}
  end
  haves.each do |peer|
    type = peer[0]
    host, port, user, pass = peer[1], peer[2].to_i, peer[3], peer[4]
    peer = type2class(type).new(host, port, user, pass)
    puts "remove torrent from #{host}:#{port}"
    begin
      peer.remove(id) unless c.dryrun
    rescue
    end
  end
end
